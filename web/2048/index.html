<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>2048 –≤ Telegram</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;text-align:center;background:#faf8ef;margin:0;padding:1em}
    h1{font-size:2em;margin:.2em 0}
    .score{font-size:1.4em;margin:.5em}
    .grid{display:inline-block;background:#bbada0;padding:.5em;border-radius:6px;position:relative}
    .row{display:flex}
    .cell{width:70px;height:70px;background:#cdc1b4;margin:5px;border-radius:3px;font-size:2em;font-weight:bold;line-height:70px;color:#776e65}
    .cell-2{background:#eee4da}.cell-4{background:#ede0c8}.cell-8{background:#f2b179;color:#f9f6f2}
    .cell-16{background:#f59563;color:#f9f6f2}.cell-32{background:#f67c5f;color:#f9f6f2}
    .cell-64{background:#f65e3b;color:#f9f6f2}.cell-128{background:#edcf72;color:#f9f6f2;font-size:1.6em}
    .cell-256{background:#edcc61;color:#f9f6f2;font-size:1.6em}.cell-512{background:#edc850;color:#f9f6f2;font-size:1.6em}
    .cell-1024{background:#edc53f;color:#f9f6f2;font-size:1.3em}.cell-2048{background:#edc22e;color:#f9f6f2;font-size:1.3em}
    #retry{display:none;margin:1em auto;padding:.6em 1.2em;font-size:1.1em;border:0;border-radius:4px;background:#8f7a66;color:#f9f6f2;cursor:pointer}
  </style>
</head>
<body>
  <h1>2048</h1>
  <div class="score">–°—á—ë—Ç: <span id="score">0</span></div>
  <div class="grid" id="grid"></div>
  <button id="retry" onclick="retry()">üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>

  <script>
    const size = 4, target = 2048;
    let board, score, won = false, grid = document.getElementById('grid'), scoreEl = document.getElementById('score'), retryBtn = document.getElementById('retry');

    function init() {
      board = Array.from({length: size}, () => Array(size).fill(0));
      score = 0;
      won = false;
      retryBtn.style.display = 'none';
      addTile(); addTile();
      updateUI();
    }
    function addTile() {
      let empties = [];
      for (let r = 0; r < size; r++) for (let c = 0; c < size; c++) if (board[r][c] === 0) empties.push({r, c});
      if (empties.length) {let {r, c} = empties[Math.floor(Math.random() * empties.length)]; board[r][c] = Math.random() < 0.9 ? 2 : 4;}
    }
    function updateUI() {
      grid.innerHTML = ''; scoreEl.textContent = score;
      for (let r = 0; r < size; r++) {
        let row = document.createElement('div'); row.className = 'row';
        for (let c = 0; c < size; c++) {
          let tile = document.createElement('div');
          tile.className = 'cell' + (board[r][c] ? ' cell-' + board[r][c] : '');
          tile.textContent = board[r][c] || '';
          row.appendChild(tile);
        }
        grid.appendChild(row);
      }
      if (won) {retryBtn.style.display = 'block'; notifyWon();}
    }
    function move(dir) {
      let moved = false, newBoard = board.map(r => [...r]);
      for (let i = 0; i < size; i++) {
        let line = (dir === 0 || dir === 2) ? newBoard[i] : newBoard.map(r => r[i]);
        if (dir === 2 || dir === 3) line.reverse();
        let merged = [], prev = null;
        for (let num of line) if (num) {
          if (prev && prev.v === num && !prev.m) {merged.push({v: prev.v * 2, m: 1}); score += prev.v * 2; prev = null;}
          else {if (prev) merged.push(prev); prev = {v: num, m: 0};}
        }
        if (prev) merged.push(prev);
        while (merged.length < size) merged.push({v: 0, m: 0});
        line = merged.map(o => o.v);
        if (dir === 2 || dir === 3) line.reverse();
        if (dir === 0 || dir === 2) newBoard[i] = line; else for (let j = 0; j < size; j++) newBoard[j][i] = line[j];
      }
      for (let r = 0; r < size; r++) for (let c = 0; c < size; c++) if (board[r][c] !== newBoard[r][c]) moved = true;
      if (moved) {board = newBoard; addTile();}
      updateUI();
      checkWin();
    }
    function checkWin() {
      for (let r = 0; r < size; r++) for (let c = 0; c < size; c++) if (board[r][c] === target && !won) {
        won = true; if (window.Telegram.WebApp) window.Telegram.WebApp.sendData("2048");
      }
    }
    function notifyWon() {
      if (window.Telegram.WebApp) {
        window.Telegram.WebApp.showAlert("üéâ –°–æ–±—Ä–∞–Ω–æ 2048! –ù–∞–≥—Ä–∞–¥–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∞.");
        window.Telegram.WebApp.sendData("2048");   // ‚Üê –ø—Ä–∏–ª–µ—Ç–∏—Ç –≤ –±–æ—Ç
      }
    }
    function retry() {init();}
    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowUp') move(0);
      else if (e.key === 'ArrowDown') move(2);
      else if (e.key === 'ArrowLeft') move(3);
      else if (e.key === 'ArrowRight') move(1);
    });
    let touchStartX = 0, touchStartY = 0;
    document.addEventListener('touchstart', e => {touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY;});
    document.addEventListener('touchend', e => {
      let dx = e.changedTouches[0].clientX - touchStartX, dy = e.changedTouches[0].clientY - touchStartY;
      if (Math.abs(dx) > Math.abs(dy)) dx > 0 ? move(1) : move(3);
      else dy > 0 ? move(2) : move(0);
    });
    init();
  </script>
</body>
</html>